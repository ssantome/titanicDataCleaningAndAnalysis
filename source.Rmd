---
title: 'Limpieza y análisis de datos del Titanic'
author: "Autores: Saúl Santomé Rúa y Víctor Elías Afonso Rodríguez"
date: "Mayo 2021"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Cargamos los paquetes R que vamos a usar
library(ggplot2)
library(dplyr)
library(kableExtra)
# Cargamos el fichero de datos
titanicData <- read.csv('titanicData.csv',stringsAsFactors = FALSE)
filas=dim(titanicData)[1]
columnas=dim(titanicData)[2]
```

# 1. Descripción del dataset. ¿Por qué es importante y qué pregunta/problema pretende responder?                 
  Este *dataset* es interesante porque permite analizar los diferentes perfiles que pudieron acceder al gran barco del momento y además da la posibilidad de localizar que variables permitieron que algunos pasajeros sobrevivieran o no. Consideramos que es un análisis relevante porque conocer los factores que separó a los pasajeros de la vida o muerte se pueden identificar, esto nos lleva a entender mejor como era la sociedad de aquella época.                     
  Vamos a visualizar la estructura del conjunto de datos.
```{r, echo=FALSE}
# Verificamos la estructura del conjunto de datos
str(titanicData)
```
  Este juego de datos esta compuesto por **891 observaciones y por 12 variables**. Los datos se encuentran en inglés.  
  
  Las **variables** son:
```{r}
names(titanicData)
```
  - **PassengerId**: Es un número que corresponde con el código de cada pasajero.            
  - **Survived**: Indica si el pasajero sobrevivio o no. Los supervivientes se indica con un "1" y los no supervivientes con un "0".         
  - **Pclass**: Indica la clase en la que se encuentra el pasajero.       
  - **Name**: Es el nombre.            
  - **Sex**: Indica si es masculino o femenino.     
  - **Age**: Corresponde con la edad.      
  - **SibSp**: Es el número de hermanos.     
  - **Parch**: Es el número de niños.       
  - **Ticket**: Número de ticket.       
  - **Fare**: Precio que ha pagado.       
  - **Cabin**: Número de cabina.     
  - **Embarked**: Puerto de embarque.       
  
  Vamos a dividir estas variables en cuantitativas y cualitativas.          

  Las **variables cualitativas** son las siguientes:
```{r, echo=FALSE}
names<-colnames(titanicData)
idQualitative<- which(names=="Name"|names=="Sex"|names=="Ticket"|names=="Cabin"|names=="Embarked")
kable( sapply(titanicData[idQualitative],class),caption="Variables cualitativas, tipos interpretados")
```
  
  Las **variables cuantitativas** son:
  
```{r}
idQuantitative<-which(names=="PassengerID"|names=="Survived"|names=="Pclass"|names=="Age"|names=="Sibsp"|names=="Parch"|names=="Fare")
kable( sapply(titanicData[idQuantitative],class),caption="Variables cualitativas, tipos interpretados")
```
  Vamos a ver **datos estadísticos** de cada variable cuantitativa para entender mejor cada una:
```{r echo=TRUE, message=FALSE, warning=FALSE}
titanicData<-titanicData[,-c(12)]
titanicData<-titanicData[,-c(11)]
titanicData<-titanicData[,-c(9)]
titanicData<-titanicData[,-c(5)]
titanicData<-titanicData[,-c(4)]
summary(titanicData)
titanicData <- read.csv('titanicData.csv',stringsAsFactors = FALSE)
```

  Gracias a este resumen podemos tener una visión del conjunto de los datos. Podemos determinar:          
  - **PassegengerID**: Funciona como el número de identificación de cada pasajero. Lo que significa que cada pasajero tiene un número de identificación, este número de identificación es una variable prescidinble ya que el valor que puede aportar es un valor en base a como asignaron cada número a cada pasajero, con lo cual no enriquece el análisis.       
  - **Survived**: Tiene un comportamiento binario.       
  - **Age**: Nos indica que hay anomalias ya que el valor mínimo es inferior a 1.     
  - **Parch**: Observamos que el valor oscila entre 0 y 6.     
  - **Fare**: Muestra que hay pasajeros que ha entrado gratis y la mayor cuantía que se ha pagado.    
  
  Una vez que conocemos mejor las variables vamos a visualizar los valores que toma cada **variable cualitativa**:
  
  **Name**
```{r}
table(titanicData$Name)
```
  Verificamos que no hay valores vacíos.                    
  
  **Sex**
```{r}
table(titanicData$Sex)
```
  Esta variable no tiene observaciones sin valor.
```{r}
577/891*100
```
  Casi el 65% de los pasageros son de género masculino.                     
  
  **Ticket**                           
```{r}
table(titanicData$Ticket)
```
  Observamos que no tiene valores vacíos y que no todos los valores son únicos.                       
  
  **Cabin**
```{r}
table(titanicData$Cabin)
```
  Observamos que tiene 687 observaciones sin valor.                             
  
  **Embarked**
```{r}
table(titanicData$Embarked)
```
  Obtenemos que esta variable puede encontrarse de 3 maneras diferentes y tiene 2 observaciones sin valor.                     
  
  Una vez que conocemos mejor las variables vamos a visualizar los valores que toma cada **variable cuantitativa**:                   

  **Survived**
```{r}
table(titanicData$Survived)
```
```{r}
342/549*100
```
  El 62% de los pasajeros fallecieron.          
  
  **Pclass**
```{r}
table(titanicData$Pclass)
```
  Solo hay 3 clases diferentes y la menos numerosa es la segunda.     
  
  **Age**
```{r}
table(titanicData$Age)
```
  Observamos que hay decimales. Lo que indica que nos puede resultar interesante agrupar para que los valores de las observaciones en valores enteros.  
  
  **SibSp**
```{r}
table(titanicData$SibSp)
```
  Hay 9 elementos diferentes y nos indica que el grueso de observaciones son de 0 hermanos.      

  **Parch**
```{r}
table(titanicData$Parch)
```
  Lo más habitual es que no tuvieran niños. 
  
  **Fare**
```{r}
table(titanicData$Fare)
```
  No hay valores vacíos.
  
# 2. Integración y selección de los datos de interés a analizar                   
  Hay variables que no vamos a necesitar:    
  - PassengerId          
  - Name          
  - Ticket
  - Fare
  - Cabin           
  - Embarked
```{r}
titanicData<-titanicData[,-c(12)]
titanicData<-titanicData[,-c(11)]
titanicData<-titanicData[,-c(10)]
titanicData<-titanicData[,-c(9)]
titanicData<-titanicData[,-c(4)]
titanicData<-titanicData[,-c(1)]

```
  Esto significa que nos quedamos solo con 6 variables. 
```{r}
summary(titanicData)
```
# 3. Limpieza de los datos                 
# 3.1 ¿Los datos contienen ceros o elementos vacíos? ¿Cómo gestionarías cada uno de estos casos?                
  Como hemos identificado anteriormente la única variable que tiene valores nulos es *Age*. 
```{r}
colSums(is.na(titanicData))
colSums(titanicData=="")
```
    Hay un total de 177 pasajeros que no tienen edad.
```{r}
177/891*100
```
  Es casi un 20% de las observaciones, esto significa que la cantidad de datos que faltan son **muy significativos**, por lo que tenemos que tratarlos. Asignamos la edad media de cada pasajero teniendo en cuenta su sexo.      
```{r}
# Ponemos la media a los valores vacíos de la variable "Age"
women_df <-titanicData[titanicData$Sex == "female",]
women_mean_age <- mean(titanicData$Age, na.rm= TRUE)
print(women_mean_age)
men_df <-titanicData[titanicData$Sex == "male",]
men_mean_age <- mean(men_df$Age, na.rm= TRUE)
print(men_mean_age)
titanicData$Age[is.na(titanicData$Age) & titanicData$Sex=="female" ] <- women_mean_age
titanicData$Age[is.na(titanicData$Age) & titanicData$Sex=="male" ] <- men_mean_age
```
  **Hemos borrado las variables ¿Mantenemos esta parte o la quitamos?**
  
  **Hay variables con valores vacíos que no estamos usando como*:**
  
  **Cabin: en cabin hay muchisimos vacios, se podría intentar identificar el por que... van menos de un dia y no duermen, no pagaron camarote, son personal del barco y no tienen asignado camarote, etc... hay que ver como solventar que esta variable este vacia. aqui lo mejor creo que es ponerle un "desconocido" ya que cualquier otro valor daria resultados erroneos en el analisis, y borrarlos es exagerado ya que hay muchisimos.**
```{r}
# Ponemos valor "Desconocido" a los valores vacíos de la variable "Cabin"
titanicData$Cabin[titanicData$Cabin==""]="Desconocido"
```
  
 **Embarked: aquí solo hay 2 valores vacios, seria una buena opcion borrarlos y olvidarse de ellos, pero hay que valorarlo.**
```{r}
#Borramos los valores vacios de embarked
titanicData <- titanicData[!titanicData$Embarked=="",]
```

# 3.2. Identificación y tratamiento de valores extremos.

  Vamos a analizar los valores extremos, la mejor manera de identificarlos es a través de los boxplot:
```{r}
library(reshape)
boxplot(data=melt(titanicData), value~variable, las=1, main="Boxplot de todos los atributos")
summary(titanicData)
```
  Observamos que hay 3 variables con **valores extremos**. Estas variables son:
  - Age                   
  - SibSp               
  - Parch          
  
  Podemos plantearnos que tanto *SibSp* como *Parch* son factores, por lo que realmente no son **valores atípicos**, por lo que realmente el enfoque tenemos que ponerlo en *Age*. *Age* tiene los valores correctos ya que corresponde con edades lógicas, por lo que procedemos a dejarla correctamente. 

# 4. Análisis de los datos            
## 4.1 Selección de los grupos de datos que quiere analizar/comparar (planificación de los análisis a aplicar)                
  Vamos a realizar las siguientes variables:                          
  - Survived vs Pclass                
  - Survived vs Sex            
  - Survived vs Age           
  - Survived vs SibSp             
  - Survived vs Parch              
  - Age vs Pclass                   
  - Age vs SibSp               
  - Age vs Parch              

## 4.2 Comprobación de la normalidad y homogeneidad de la varianza  

## 4.3 Aplicación de pruebas estadísticas para comparar los grupos de datos. En función de los datos y el objetivo del estudio, aplicar pruebas de contraste de hipótesis, correlaciones, regresiones, etc. Aplicar al menos tres métodos de análisis diferentes

# 5. Representación de los resultados a partir de tablas y gráficas

# 6. Resolución del problema. A partir de los resultados obtenidos, ¿cuáles son las conclusiones? ¿Los resultados permiten responder al problema?


```{r}
summary(titanicData)
```


Ahora vamos a discretizar la variable edad, que nos resultará útil a la hora de analizar.....

```{r echo=TRUE, message=FALSE, warning=FALSE}
# Añadimos la edad discretizada al dataset. Discretizamos con intervalos de igual amplitud

summary(titanicData[,"Age"])

titanicData$Age <- cut(titanicData$Age, breaks = c(0,10,20,30,40,50,60,70,81), labels = c("0-9", "10-19", "20-29", "30-39","40-49","50-59","60-69","70-80"))

head(titanicData)

plot(titanicData$Age)

```

Tambien se podría normalizar un dato, para "demostrar" que sabemos hacerlo jajaja. pero bueno, tampoco es muy necesario, aunque es muy sencillo, por ejemplo.

```{r echo=TRUE, message=FALSE, warning=FALSE}
#Normalizacion por la diferencia
minFare = min(titanicData$Fare)
maxFare = max(titanicData$Fare)
diffMinMaxFare = maxFare - minFare

titanicData["Fare_norm"] <- ((titanicData$Fare - minFare) / diffMinMaxFare)
head(titanicData)

```




Simplificacion de datos:  Ahora vamos a analizar los valores redundantes, o que simplemente no tengan una funcion especial en el dataset, como por ejemplo, el nombre de los pasajeros no es nada util teniendo un id de pasajero, asi que podriamos simplemente eliminar esa columna.

se puede tambien hacer alguna comparacion entre si 2 campos coinciden mucho, pero ya se ve a suimple vista que no, asi que no seria muy necesario




Ahora se podrian ver valores extremos. por ejemplo el precio, que hay un billete que valio mas de 500 € como vimos en el summary

aqui podemos aprovechar nuestra variable normalizada o no, tanto da


```{r echo=TRUE, message=FALSE, warning=FALSE}
#representación de la distribución de los precios de los billetes
ggplot(data=titanicData, aes(x=Fare)) + geom_boxplot()
ggplot(data=titanicData, aes(x=Fare_norm)) + geom_boxplot()


```

Vemos como el valor de 500 es altamente extraño, podriamos buscarle solucion, o eliminarlo, tambien hay valores por encima de 200 que chirrian un poco, pero aqui ya se podria ver si coinciden con camarotes de lujo etc. 


Creo que no hay mas variables donde ver valores extremos.


## Analisis



Como la varaible survived es una clase vamos a discretizar la varaible tranformandola a string
```{r echo=TRUE, message=FALSE, warning=FALSE}

titanicData["Survived_discreta"] <- cut(titanicData$Survived, breaks = c(-1,0.5,1), labels = c("No", "Si"))

head(titanicData)

plot(titanicData$Survived_discreta)

```

Esto se puede usar como introducción y para tener una idea visual de como afectan las diferentes variables en la supervivencia y asi elegir que datos analizar. Antes de hacerlo de la homogeniedad y normalidad, y aplicar las correlaciones, regrasiones, etc.

A partir de aqui ya comenzariamos con el analisis de los datos, asi que hay que empezar a comparar los diferentes atributos con la varaible survived

Empezamos por la edad

```{r echo=TRUE, message=FALSE, warning=FALSE}
ggplot(data=titanicData, aes(x=Age, y=Survived_discreta)) + geom_boxplot()

```

Sex

No se por que coño sale NA aqui, hay que arreglarlo, pero no encuentro el por que

```{r echo=TRUE, message=FALSE, warning=FALSE}
ggplot(data=titanicData[1:filas,],aes(x=Sex,fill=Survived_discreta))+geom_bar()

```

Relacion entre age y sex para ampliar explicacion sobre los datos de antes
```{r echo=TRUE, message=FALSE, warning=FALSE}
ggplot(data=titanicData[1:filas,],aes(x=Age_discreta,fill=Sex))+geom_bar(position="fill")+ylab("Frecuencia")

```

Ahora hay que seguir buscando relaciones interesantes para completar el analisis



```{r echo=TRUE, message=FALSE, warning=FALSE}

ggplot(data=titanicData[1:filas,],aes(y=Embarked,fill=Survived_discreta))+geom_bar(position="fill")

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

ggplot(data=titanicData[1:filas,],aes(y=Pclass,fill=Survived_discreta))+geom_bar(position="fill")+facet_wrap(~Embarked)+theme(axis.text.y = element_text(size = rel(0.7)))

```
Y a partir de aqui todas las combinaciones de columnas y graficas de las que podamos sacar algo de partido para explicar bien el analisis

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE}

```
